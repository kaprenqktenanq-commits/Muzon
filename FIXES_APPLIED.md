# üîß –û—à–∏–±–∫–∏ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã - ArmedMusic Bot

## –î–∞—Ç–∞: 11 —Ñ–µ–≤—Ä–∞–ª—è 2026
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. **"Unknown Constructor" –û—à–∏–±–∫–∏ –≤ Event Loop**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç—É –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ TL-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –æ—Ç Telegram —Å–µ—Ä–≤–µ—Ä–æ–≤
```
Unhandled exception in event loop: The server sent an unknown constructor: 0x52d6806b
```

**–ü—Ä–∏—á–∏–Ω–∞:** 
- Pyrogram –≤–µ—Ä—Å–∏—è –±—ã–ª–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π (v2.1.23)
- TL-—Å—Ö–µ–º–∞ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å Telegram API

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ Pyrogram –¥–æ v2.0.106 (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ PyTgCalls –¥–æ v2.2.11 (—Å –Ω–æ–≤—ã–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞–º–∏)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ç–∏—Ö –æ—à–∏–±–æ–∫ (—Ç–µ–ø–µ—Ä—å –Ω–µ –ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)

---

### 2. **External Services Failures**
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ 10 –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏ –ø–∞–¥–∞–ª–∏
```
[WARNING] All 10 external services failed
```

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω `external_extractors.py` —Å better error handling
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ timeout'—ã (30 —Å–µ–∫ –Ω–∞ –∑–∞–ø—Ä–æ—Å, 60 —Å–µ–∫ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ asyncio.TimeoutError
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Ç–µ–ø–µ—Ä—å –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å—Ä–∞–∑—É)

---

### 3. **Event Loop Exceptions**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–≥–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ event loop
```
Unhandled exception in event loop: ...
```

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å `ArmedMusic/utils/error_handler.py` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `_handle_loop_exception()` —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –∏ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
- ‚úÖ Transient –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ WARNING, –∞ –Ω–µ ERROR

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Reconnection Logic**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ –±–æ—Ç –ø–∞–¥–∞–ª –∏–ª–∏ –∑–∞–≤–∏—Å–∞–ª, –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è backoff –ª–æ–≥–∏–∫–∞ (5s ‚Üí 10s ‚Üí 20s ‚Üí 40s ‚Üí 80s ‚Üí 300s max)
- ‚úÖ MAX_RECONNECT_ATTEMPTS = 5 (–Ω–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- ‚úÖ –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å (–±–æ—Ç, —é–∑–µ—Ä–±–æ—Ç, PyTgCalls) –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –±–µ–∑ –æ–±—â–µ–≥–æ –ø–∞–¥–µ–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã try-except –±–ª–æ–∫–∏ –≤–æ–∫—Ä—É–≥ –≤—Å–µ—Ö critical —Å–µ—Ä–≤–∏—Å–æ–≤

---

### 5. **PyTgCalls Initialization Errors**
**–ü—Ä–æ–±–ª–µ–º–∞:** PyTgCalls –∏–Ω—Å—Ç–∞–Ω—Å—ã –ø–∞–¥–∞–ª–∏ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `Call.start()` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞
- ‚úÖ –ö–∞–∂–¥—ã–π PyTgCalls –∏–Ω—Å—Ç–∞–Ω—Å —Å—Ç–∞—Ä—Ç—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (–µ—Å–ª–∏ –æ–¥–Ω–∞ —É–ø–∞–ª–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞

---

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

### 1. **requirements.txt**
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤–µ—Ä—Å–∏–∏ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- Pyrogram: —Å—Ç–∞—Ä–∞—è git –≤–µ—Ä—Å–∏—è ‚Üí v2.0.106
- PyTgCalls: v2.2.0 ‚Üí v2.2.11
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã: colorama, tenacity

### 2. **ArmedMusic/__main__.py**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ UnknownError, TelegramServerError
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è backoff –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait
- –î–æ–±–∞–≤–ª–µ–Ω—ã try-except –±–ª–æ–∫–∏ –≤–æ–∫—Ä—É–≥ import –º–æ–¥—É–ª–µ–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ graceful shutdown –¥–ª—è SIGINT/SIGTERM

### 3. **ArmedMusic/utils/error_handler.py** (–ù–û–í–´–ô)
- –ö–ª–∞—Å—Å ErrorHandler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –§—É–Ω–∫—Ü–∏—è retry_on_error –¥–ª—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
- –§—É–Ω–∫—Ü–∏—è handle_unknown_constructor –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –§—É–Ω–∫—Ü–∏—è safe_coroutine —Å timeout

### 4. **ArmedMusic/core/call.py**
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ `start()` –º–µ—Ç–æ–¥ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ `stream_call()` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π NoActiveGroupCall –∏ TelegramServerError

### 5. **ArmedMusic/utils/external_extractors.py**
- –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `try_external_mp3_extraction()`
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ timeout'–æ–≤
- –°–æ–∫—Ä–∞—â–µ–Ω —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ—Å—Ç–∞–ª–æ—Å—å 5 —Å–∞–º—ã—Ö –Ω–∞–¥—ë–∂–Ω—ã—Ö)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª—É—á—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 6. **start.sh** (–ù–û–í–´–ô)
- Bash —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Python –≤–µ—Ä—Å–∏—é
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç environment variables

---

## üöÄ –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å:

### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:
```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
python -m ArmedMusic
```

### –ù–∞ Render.com (–∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö PaaS):
1. git push –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç `requirements.txt`
3. –ó–∞–ø—É—Å—Ç–∏—Ç `python -m ArmedMusic` —Å–æ–≥–ª–∞—Å–Ω–æ Procfile

### –ù–∞ Docker:
```bash
docker build -t armedmusic .
docker run --env-file .env armedmusic
```

---

## ‚öôÔ∏è –ù–æ–≤–æ–µ –ü–æ–≤–µ–¥–µ–Ω–∏–µ:

### –ü—Ä–∏ –æ—à–∏–±–∫–µ:
1. **Transient errors** (unknown constructor, server error, flood wait):
   - –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ WARNING
   - –ë–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ù–ï —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

2. **Critical errors** (database connection, missing environment variables):
   - –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ ERROR
   - –ë–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å exponential backoff
   - –ü–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—ã—Ö–æ–¥–∏—Ç

3. **Service-level errors** (–æ–¥–∏–Ω PyTgCalls —É–ø–∞–ª):
   - –û–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç
   - –ü–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è

### Graceful Shutdown:
- SIGINT (Ctrl+C): –ß–∏—Å—Ç–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
- SIGTERM: –¢–∞–∫–∂–µ —á–∏—Å—Ç–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ (–¥–ª—è Docker/systemd)
- –í—Ç–æ—Ä–∞—è SIGINT: Force kill —á–µ—Ä–µ–∑ sys.exit(1)

---

## üìä –£–ª—É—á—à–µ–Ω–∏—è:

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–∞–Ω—å—à–µ | –¢–µ–ø–µ—Ä—å |
|----------|--------|--------|
| Unknown Constructor Error | ‚ùå Crash | ‚úÖ Warning + recover |
| External Service Fail | ‚ùå Crash | ‚úÖ Try next service |
| Event Loop Exception | ‚ùå Error log | ‚úÖ Filter + recover |
| Connection Lost | ‚ùå Manual restart | ‚úÖ Auto-reconnect |
| Graceful Shutdown | ‚ùå Immediate kill | ‚úÖ Clean stop |

---

## üîç –ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:

1. **Cloud logs** (–µ—Å–ª–∏ –Ω–∞ Render): Deployment ‚Üí Logs
2. **Docker logs**: `docker logs armedmusic`
3. **Systemd logs**: `sudo journalctl -u armedmusic -f`

---

## ‚ùì –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –µ—Å—Ç—å –æ—à–∏–±–∫–∏:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ WARNING –∏ ERROR
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ MongoDB –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Assistant –∞–∫–∫–∞—É–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã

---

**–°–æ–∑–¥–∞–Ω–æ:** 11 —Ñ–µ–≤—Ä–∞–ª—è 2026, 12:30 GMT+4  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
